# sql4transepi

  ![release](https://img.shields.io/badge/release-beta-brightgreen)
  [![GPLv3 license](https://img.shields.io/badge/licence-GPL_v3-blue.svg)](http://perso.crans.org/besson/LICENSE.html)
  ![DOI](https://img.shields.io/badge/DOI-TBC-blue.svg)

Python scripts for building and querying PostgreSQL databases. These are designed for working with databases of products and transactions in the context of transactional epidemiology.

## Getting Started

1. Copy the files in this repository to your machine, either through the [download](https://github.com/altanner/sql4transepi/archive/refs/heads/main.zip) link, or by cloning the repo:

`git clone https://github.com/altanner/sql4transepi.git`

and move into the repository folder:

`cd sql4transepi`

2. Install Postgres for the command line. You can follow a [instructions](https://www.postgresqltutorial.com/install-postgresql/) to do this here. There are guides for Linux, MacOS and Windows in that link.

3. Create a database called "TE_DB" to receive the incoming data. This can be done by running `createdb` (this is a postgres-installed command):

`createdb TE_DB`

If you get a `role does not exist` error, run this command to make yourself the owner of the database:

`sudo -u postgres createuser --superuser $USER`

4. Have Python >= 3.8 installed, and create a fresh virtual environment. This command create a folder with clean Python binaries which we can then update to be streamlined for these scripts:

`python -m venv ./venv`

5. activate this clean Python with

`source ./venv/bin/activate`

(to leave this virtual environment, type `deactivate`)

6. finally, install the `requirements.txt` file to get your libraries into this fresh Python

`pip install -r requirements.txt`

You will now be ready to use these scripts.


## Scripts

All scripts provide full help details by adding the flag `--help`, for example

```python boots_card_CSV2PG.py --help```

#### • boots_card_CSV2PG.py 
Boots loyalty card data is provided as CSV (UTF16, tab separated). This script converts the file to UTF8 csv, and imports it to a Postgres table. Example:

```python boots_card_CSV2PG.py -i my_card.csv```


#### • boots_scrape_CSV2PG.py
Boots product database scrape (as generated by github.com/altanner/snax2) is CSV. This imports the scrape of products to a Postgres table.

```python boots_scrape_CSV2PG.py -i scrape_2021-09-15T01:00:05.csv```


#### • boots_PG_querier.py
This script allows SQL queries to be applied to both Boots cards and Boots product database, and applying SQL JOINs between tables.

```python boots_PG_querier.py --product 8899118```


#### • tesco_card_JSON2CSV.py 
Tescos loyalty card data is provided as nested JSON. This script creates a CSV, with one item per row, and adding a storeID, timestamp and a hash-generated customer ID to each transaction item. (Tescos cards data do not have complete card numbers, or any other customer-identifiers.)

```python tesco_card_JSON2CSV.py -i my_tesco_data210929.json```


#### • tesco_card_CSV2PG.py 
This script imports the CSV file output of tesco_card_JSON2CSV.py into a Postgres table.

```python tesco_card_CSV2PG.py -i my_card.csv```

